{% load qr_code %}{% load static %}
<!-- <script src="{% static 'assets/default/js/jquery-3.6.0.min.js' %}"></script> -->
<script src="{% static 'assets/instascan.min.js' %}"></script>

<!-- CSS Config -->
 
<style>
    #uni_modal .modal-footer {
        display: none
    }
    
    #uni_modal .modal-sub-footer {
        display: flex
    }
    
    #scanner {
        width: 100%;
        height: 50vh;
        margin: 0px auto;
        position: relative;
        object-fit: cover;
        object-position: center center;
    }
    
    #scanner-focus {
        background: #00000085;
        -webkit-clip-path: polygon(0% 0%, 0% 100%, 25% 100%, 25% 25%, 75% 25%, 75% 75%, 25% 75%, 25% 100%, 100% 100%, 100% 0%);
        clip-path: polygon(0% 0%, 0% 100%, 25% 100%, 25% 25%, 75% 25%, 75% 75%, 25% 75%, 25% 100%, 100% 100%, 100% 0%);
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
    }
</style>

<!-- HTML Config -->

<div class="container-fluid">
    <div id="scanner-holder" class="position-relative">
        <video id="scanner"></video>
        <div id="scanner-focus" class="position-absolute">

        </div>
    </div>
</div>

<script>

    // Initializes the Scanner & Stream Handling

    const args = {
        video: document.getElementById('scanner'),
        mirror: false
    };

    window.URL.createObjectURL = (stream) => {
        args.video.srcObject = stream;
        return stream;
    };

    const scanner = new Instascan.Scanner(args);
    
    // Scab Listener: When a QR code is scanned, this listener triggers

    scanner.addListener('scan', function(content) {
    // Hide the modal
    $('.modal').modal('hide');
    start_loader();
    
    // Save the scanned content (which is the employee_code)
    const scannedData = content;
    
    const currentDateTime = new Date(); // This gets the current date and time
    const formattedDateTime = currentDateTime.toLocaleString();

// If you want to format it as a string, you can use toLocaleString or other methods
    console.log("Current Date and Time:", formattedDateTime);

    // Log the scanned data for verification
    console.log("Scanned Employee Code:", scannedData);

    // Set a timeout to allow for any necessary loading
    setTimeout(() => {
        // Make an API call to fetch user information
        fetch(`/api/employee/?employee_code=${scannedData}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Log the fetched user data for verification
                console.log("Fetched User Data:", data);
                
                // Check if necessary information is present and filter for specific user
                const specificUser = data.find(user => user.employee_code === scannedData); // Match employee_code
                
                if (specificUser) {
                    console.log("Specific User Information:", specificUser);
                    
                    // Now fetch log records based on employee_pk (which corresponds to specificUser.id)
                    return fetch(`/api/logrecord/?employee_pk=${specificUser.id}`)
                        .then(logResponse => {
                            if (!logResponse.ok) {
                                throw new Error('Failed to fetch log records');
                            }
                            return logResponse.json();
                        })
                        .then(logData => {
                            if (logData) {
                                // Filter log records to only include those with the specific employee_pk
                                const filteredLogRecords = logData.filter(record => record.employee_pk === specificUser.id);
                                
                                // Log the filtered log records for verification
                                console.log("Filtered Log Records for Employee PK:", filteredLogRecords);
                                
                                // Further process filteredLogRecords as needed here
                            }
                        });
                } else {
                    console.warn("No matching user found for employee code:", scannedData);
                }
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            })
            .finally(() => {
                scanner.stop(); // Stop the scanner after processing
                stop_loader(); // Stop loading animation if applicable
            });
    }, 500);
});
        // $('.modal').modal('hide')
        // start_loader()
        // setTimeout(() => {
        //     uni_modal("QR Attendance Tracker", "{% url 'employee_attendance' %}/" + content, 'modal-md')
        //     scanner.stop()
        // }, 500)

    // Checks for available cameras. 

    $('#uni_modal').on('shown.bs.modal', function() {
        if ($('#scanner').length > 0) {
            scanner.stop()
            Instascan.Camera.getCameras().then(function(cameras) {
                if (cameras.length > 0) {
                    scanner.start(cameras[0]);
                } else {
                    console.error('No cameras found.');
                }
            }).catch(function(e) {
                console.error(e);
            });
        }
    })
    $('#uni_modal').on('hide.bs.modal', function() {
        scanner.stop()
    })
</script>